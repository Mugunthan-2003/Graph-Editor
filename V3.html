<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Graph Editor – cola.js physics</title>

<script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/webcola@3.4.0/WebCola/cola.min.js"></script>
<script src="https://unpkg.com/cytoscape-cola@2.5.1/cytoscape-cola.js"></script>

  <style>
    #cy, #subgraph-cy {
      width: 90%;
      height: 95vh;
      border: 1px solid #ccc;
      margin: 20px auto;
      position: relative;
      user-select: none;
    }
    #controls, #subgraph-controls {
      margin: 10px auto;
      width: 100%;
      text-align: center;
    }
    #controls button, #subgraph-controls button {
      margin: 0 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    hr.double-line {
      border: none;
      border-top: 3px double #333;
      margin: 20px auto;
      width: 90%;
    }
    h1 { text-align: center; }
  </style>
</head>
<body>
  <h1>Interactive Graph Editor cola.js physics</h1>

  <div id="controls">
    <button id="fileimport">Import</button>
    <button id="addNodeBtn">Add Node</button>
    <button id="addEdgeBtn">Add Edge</button>
    <button id="addConnectedNodeBtn" disabled>Add Connected Node (+)</button>
    <button id="renameBtn" disabled>Change Label</button>
    <button id="modifySizeBtn" disabled>Modify Size</button>
    <button id="deleteBtn" disabled>Delete</button>
    <button id="clearAllBtn">Clear All</button>
    <button id="downloadJsonBtn">Export(JSON)</button>
    <button id="showSubgraphBtn" disabled>SubGraph</button>
  </div>

  <div id="cy"></div>

  <script>
    // -------------------------------------------------
    // Register the cola extension (must be done once)
    // -------------------------------------------------
    cytoscape.use(cytoscapeCola);

    const cyContainer = document.getElementById('cy');
    const addNodeBtn = document.getElementById('addNodeBtn');
    const addEdgeBtn = document.getElementById('addEdgeBtn');
    const addConnectedNodeBtn = document.getElementById('addConnectedNodeBtn');
    const renameBtn = document.getElementById('renameBtn');
    const modifySizeBtn = document.getElementById('modifySizeBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const showSubgraphBtn = document.getElementById('showSubgraphBtn');
    const fileImportBtn = document.getElementById('fileimport');

    let subgraphContainer = null;
    let subgraphCy = null;
    let clearSubgraphBtn = null;
    let doubleLine = null;
    let subgraphTitle = null;

    // -------------------------------------------------
    // Main graph – cola layout (physics)
    // -------------------------------------------------
    const cy = cytoscape({
      container: cyContainer,
      elements: [
        { data: { id: 'a', label: 'Node A', size: 40 }, position: { x: 100, y: 100 } },
        { data: { id: 'b', label: 'Node B', size: 40 }, position: { x: 200, y: 100 } },
        { data: { id: 'c', label: 'Node C', size: 40 }, position: { x: 300, y: 100 } },
        { data: { id: 'd', label: 'Node D', size: 40 }, position: { x: 400, y: 100 } },
        { data: { id: 'ab', label: 'Edge AB', source: 'a', target: 'b', size: 3 } },
        { data: { id: 'bc', label: 'Edge BC', source: 'b', target: 'c', size: 3 } },
        { data: { id: 'cd', label: 'Edge CD', source: 'c', target: 'd', size: 3 } }
      ],
      style: [
        { selector: 'node',
          style: {
            'background-color': '#0074D9',
            label: 'data(label)',
            color: '#fff',
            'text-valign': 'center',
            'text-halign': 'center',
            'font-size': 16,
            'width': 'data(size)',
            'height': 'data(size)'
          }
        },
        { selector: 'edge',
          style: {
            'width': 'data(size)',
            'line-color': '#ccc',
            'target-arrow-color': '#ccc',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            label: 'data(label)',
            'font-size': 12,
            'text-outline-color': '#fff',
            'text-outline-width': 2
          }
        },
        { selector: '.highlighted',
          style: {
            'background-color': '#FF4136',
            'line-color': '#FF4136',
            'target-arrow-color': '#FF4136',
            'transition-duration': '0.5s'
          }
        }
      ],

      // ------------------- COLA LAYOUT -------------------
      layout: {
        name: 'cola',
        animate: true,
        refresh: 1,
        maxSimulationTime: 4000,
        fit: true,
        padding: 30,
        // optional fine-tuning
        nodeSpacing: 15,
        edgeLength: 100,
        flow: { axis: 'y', minSeparation: 40 }
      }
    });

    // -------------------------------------------------
    // All the original interaction code (unchanged)
    // -------------------------------------------------
    let selectedElement = null;
    let edgeSourceNode = null;

    /* ---------- File Import (JSON + CSV) ---------- */
    fileImportBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,.csv';
      input.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const fileContent = e.target.result;
            if (file.name.endsWith('.json')) {
              const data = JSON.parse(fileContent);
              let elements = [];

              if (data.elements) {
                elements = (data.elements.nodes || []).map(node => ({
                  group: 'nodes',
                  data: { id: node.data.id, label: node.data.label || node.data.id, size: parseInt(node.data.size) || 40 },
                  position: node.position || { x: Math.random() * 400, y: Math.random() * 400 }
                })).concat(
                  (data.elements.edges || []).map(edge => ({
                    group: 'edges',
                    data: { id: edge.data.id, label: edge.data.label || `Edge ${edge.data.source} to ${edge.data.target}`,
                            source: edge.data.source, target: edge.data.target, size: parseInt(edge.data.size) || 3 }
                  }))
                );
              } else if (data.nodes && data.edges) {
                elements = (data.nodes || []).map(node => ({
                  group: 'nodes',
                  data: { id: node.data.id, label: node.data.label || node.data.id, size: parseInt(node.data.size) || 40 },
                  position: node.position || { x: Math.random() * 400, y: Math.random() * 400 }
                })).concat(
                  (data.edges || []).map(edge => ({
                    group: 'edges',
                    data: { id: edge.data.id, label: edge.data.label || `Edge ${edge.data.source} to ${edge.data.target}`,
                            source: edge.data.source, target: edge.data.target, size: parseInt(edge.data.size) || 3 }
                  }))
                );
              } else {
                alert('Invalid JSON format.');
                return;
              }

              cy.elements().remove();
              cy.add(elements);
              cy.layout({ name: 'cola', animate: true, refresh: 1, maxSimulationTime: 4000 }).run();
            } else if (file.name.endsWith('.csv')) {
              const lines = fileContent.split('\n').map(l => l.trim()).filter(l => l);
              const elements = [];
              const nodeIds = new Set();

              lines.forEach((line, idx) => {
                if (idx === 0 && line.match(/source,target,edgeLabel/i)) return;
                const [src, tgt, eLabel, nSize, eWidth] = line.split(',').map(i => i.trim());
                if (!src || !tgt) { alert(`Bad CSV line ${idx+1}`); return; }

                if (!nodeIds.has(src)) {
                  elements.push({ group: 'nodes', data: { id: src, label: src, size: parseInt(nSize) || 40 },
                                  position: { x: Math.random()*400, y: Math.random()*400 } });
                  nodeIds.add(src);
                }
                if (!nodeIds.has(tgt)) {
                  elements.push({ group: 'nodes', data: { id: tgt, label: tgt, size: parseInt(nSize) || 40 },
                                  position: { x: Math.random()*400, y: Math.random()*400 } });
                  nodeIds.add(tgt);
                }

                elements.push({ group: 'edges',
                  data: { id: `edge_${src}_${tgt}_${Date.now()}`, label: eLabel || `${src}→${tgt}`,
                          source: src, target: tgt, size: parseInt(eWidth) || 3 }
                });
              });

              cy.elements().remove();
              cy.add(elements);
              cy.layout({ name: 'cola', animate: true, refresh: 1, maxSimulationTime: 4000 }).run();
            } else {
              alert('Only .json or .csv files are supported.');
            }
          } catch (err) {
            alert('Error: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    /* ---------- Add Node ---------- */
    addNodeBtn.addEventListener('click', () => {
      let name = prompt('Enter node label:');
      if (!name) return alert('Label required.');
      const id = 'node_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
      let sizeStr = prompt('Enter node size (10-100):', '40');
      let size = Math.min(100, Math.max(10, parseInt(sizeStr) || 40));
      cy.add({
        group: 'nodes',
        data: { id, label: name, size },
        position: { x: 300, y: 200 }
      });
      cy.layout({ name: 'cola', animate: true, refresh: 1 }).run();
    });

    /* ---------- Add Edge ---------- */
    addEdgeBtn.addEventListener('click', () => {
      if (!selectedElement || !selectedElement.isNode()) {
        alert('Select a source node first.');
        return;
      }
      edgeSourceNode = selectedElement;
      alert(`Source: "${edgeSourceNode.data('label')}". Click a target node.`);
      const tapHandler = function (evt) {
        const target = evt.target;
        if (edgeSourceNode.id() === target.id()) {
          alert('Cannot self-loop.');
          edgeSourceNode = null;
          cy.off('tap', 'node', tapHandler);
          return;
        }
        if (cy.edges(`[source="${edgeSourceNode.id()}"][target="${target.id()}"]`).nonempty()) {
          alert('Edge already exists.');
          edgeSourceNode = null;
          cy.off('tap', 'node', tapHandler);
          return;
        }
        const edgeId = 'edge_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
        let label = prompt('Edge label:', `${edgeSourceNode.data('label')} → ${target.data('label')}`);
        if (!label) return alert('Label required.');
        let sizeStr = prompt('Edge width (1-10):', '3');
        let size = Math.min(10, Math.max(1, parseInt(sizeStr) || 3));
        cy.add({
          group: 'edges',
          data: { id: edgeId, label, source: edgeSourceNode.id(), target: target.id(), size }
        });
        cy.layout({ name: 'cola', animate: true, refresh: 1 }).run();
        edgeSourceNode = null;
        cy.off('tap', 'node', tapHandler);
      };
      cy.on('tap', 'node', tapHandler);
    });

    /* ---------- Add Connected Node (+) ---------- */
    addConnectedNodeBtn.addEventListener('click', () => {
      if (!selectedElement || !selectedElement.isNode()) return alert('Select a node.');
      let name = prompt('New node label:');
      if (!name) return alert('Label required.');
      let sizeStr = prompt('Node size (10-100):', '40');
      let size = Math.min(100, Math.max(10, parseInt(sizeStr) || 40));
      const srcPos = selectedElement.position();
      const newId = 'node_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
      cy.add({
        group: 'nodes',
        data: { id: newId, label: name, size },
        position: { x: srcPos.x + 120, y: srcPos.y }
      });
      const edgeId = 'edge_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
      let edgeLabel = prompt('Edge label:', `${selectedElement.data('label')} → ${name}`);
      if (!edgeLabel) return alert('Label required.');
      cy.add({
        group: 'edges',
        data: { id: edgeId, label: edgeLabel, source: selectedElement.id(), target: newId, size: 3 }
      });
      cy.layout({ name: 'cola', animate: true, refresh: 1 }).run();
    });

    /* ---------- Rename ---------- */
    renameBtn.addEventListener('click', () => {
      if (!selectedElement) return alert('Select something.');
      let newLabel = prompt(`New label for ${selectedElement.isNode()?'node':'edge'} "${selectedElement.data('label')}":`);
      if (!newLabel) return alert('Label required.');
      selectedElement.data('label', newLabel);
    });

    /* ---------- Modify Size ---------- */
    modifySizeBtn.addEventListener('click', () => {
      if (!selectedElement) return alert('Select something.');
      const isNode = selectedElement.isNode();
      const cur = selectedElement.data('size') || (isNode?40:3);
      const range = isNode ? '10-100' : '1-10';
      let str = prompt(`New size (${range}):`, cur);
      if (!str) return;
      let val = isNode ? Math.min(100, Math.max(10, parseInt(str))) : Math.min(10, Math.max(1, parseInt(str)));
      if (!val) return alert('Invalid size.');
      selectedElement.data('size', val);
    });

    /* ---------- Delete ---------- */
    deleteBtn.addEventListener('click', () => {
      if (!selectedElement) return alert('Select something.');
      cy.remove(selectedElement);
      selectedElement = null;
      edgeSourceNode = null;
      addConnectedNodeBtn.disabled = true;
      renameBtn.disabled = true;
      modifySizeBtn.disabled = true;
      deleteBtn.disabled = true;
      showSubgraphBtn.disabled = true;
    });

    /* ---------- Clear All ---------- */
    clearAllBtn.addEventListener('click', () => {
      cy.remove(cy.elements());
      selectedElement = null;
      edgeSourceNode = null;
      addConnectedNodeBtn.disabled = true;
      renameBtn.disabled = true;
      modifySizeBtn.disabled = true;
      deleteBtn.disabled = true;
      showSubgraphBtn.disabled = true;
      if (subgraphContainer) {
        doubleLine.remove();
        subgraphTitle.remove();
        subgraphContainer.remove();
        clearSubgraphBtn.remove();
        doubleLine = subgraphTitle = subgraphContainer = subgraphCy = clearSubgraphBtn = null;
      }
    });

    /* ---------- Export JSON ---------- */
    downloadJsonBtn.addEventListener('click', () => {
      const jsonStr = JSON.stringify(cy.json().elements, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'graph_' + new Date().toISOString().replace(/[:.]/g,'-') + '.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    /* ---------- Subgraph (also uses cola) ---------- */
    showSubgraphBtn.addEventListener('click', () => {
      if (!selectedElement || !selectedElement.isNode()) return alert('Select a node.');

      // UI scaffolding
      doubleLine = document.createElement('hr'); doubleLine.className='double-line'; document.body.appendChild(doubleLine);
      subgraphTitle = document.createElement('h1'); subgraphTitle.textContent='Subgraph of ' + selectedElement.data('label'); document.body.appendChild(subgraphTitle);
      subgraphContainer = document.createElement('div'); subgraphContainer.id='subgraph-cy'; document.body.appendChild(subgraphContainer);
      const controls = document.createElement('div'); controls.id='subgraph-controls'; document.body.appendChild(controls);
      clearSubgraphBtn = document.createElement('button'); clearSubgraphBtn.textContent='Clear Subgraph'; controls.appendChild(clearSubgraphBtn);

      // Gather 2-level neighbourhood
      const l1in = selectedElement.incomers();
      const l2in = l1in.nodes().incomers();
      const l1out = selectedElement.outgoers();
      const l2out = l1out.nodes().outgoers();

      const subgraphEls = [];
      const push = ele => {
        if (ele.isNode()) subgraphEls.push({ group:'nodes', data:{id:ele.id(),label:ele.data('label'),size:ele.data('size')}, position:ele.position() });
        else if (ele.isEdge()) subgraphEls.push({ group:'edges', data:{id:ele.id(),label:ele.data('label'),source:ele.data('source'),target:ele.data('target'),size:ele.data('size')} });
      };
      push(selectedElement);
      l1in.forEach(push); l2in.forEach(push);
      l1out.forEach(push); l2out.forEach(push);

      // Subgraph cytoscape instance – also cola
      subgraphCy = cytoscape({
        container: subgraphContainer,
        elements: subgraphEls,
        style: cy.style().json(),   // reuse same style
        layout: { name: 'cola', animate:true, refresh:1, maxSimulationTime:3000, fit:true, padding:30 }
      });

      // Highlight logic (same as main graph)
      subgraphCy.on('tap', 'node,edge', evt => {
        subgraphCy.elements().removeClass('highlighted');
        const sel = evt.target;
        sel.addClass('highlighted');
        if (sel.isNode()) { sel.outgoers('edge').addClass('highlighted'); sel.outgoers('node').addClass('highlighted'); }
      });
      subgraphCy.on('tap', evt => { if (evt.target === subgraphCy) subgraphCy.elements().removeClass('highlighted'); });

      // Clear button
      clearSubgraphBtn.onclick = () => {
        doubleLine.remove(); subgraphTitle.remove(); subgraphContainer.remove(); clearSubgraphBtn.remove();
        doubleLine = subgraphTitle = subgraphContainer = subgraphCy = clearSubgraphBtn = null;
        showSubgraphBtn.disabled = false;
      };
    });

    /* ---------- Selection & Highlight (main graph) ---------- */
    cy.on('tap', 'node,edge', evt => {
      cy.elements().removeClass('highlighted');
      selectedElement = evt.target;
      selectedElement.addClass('highlighted');
      if (selectedElement.isNode()) {
        selectedElement.outgoers('edge').addClass('highlighted');
        selectedElement.outgoers('node').addClass('highlighted');
        addConnectedNodeBtn.disabled = false;
        showSubgraphBtn.disabled = false;
      } else {
        addConnectedNodeBtn.disabled = true;
        showSubgraphBtn.disabled = true;
      }
      renameBtn.disabled = modifySizeBtn.disabled = deleteBtn.disabled = false;
    });

    cy.on('tap', evt => {
      if (evt.target === cy) {
        cy.elements().removeClass('highlighted');
        selectedElement = null;
        edgeSourceNode = null;
        addConnectedNodeBtn.disabled = renameBtn.disabled = modifySizeBtn.disabled = deleteBtn.disabled = showSubgraphBtn.disabled = true;
      }
    });

  </script>
</body>
</html>